<!DOCTYPE html>
<html lang="en-us" class="wf-firasans-n4-active wf-active">
	<head>
    <link href="http://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Enable responsiveness on mobile devices --> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    
    	
    <meta name="generator" content="Hugo 0.37.1" />
    
    <title>Worst Practice Lab VM Automation &middot; YourTech</title>
    <meta content="Worst Practice Lab VM Automation - YourTech" property="og:title">
    <meta content=" - " property="og:description">    
    <!-- CSS --> 
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i|Roboto+Mono:300,300i,400,400i,700,700i" rel="stylesheet">
    <link rel="stylesheet" href="http://localhost:1313css/print.css" media="print">
    <link rel="stylesheet" href="http://localhost:1313css/poole.css">
    <link rel="stylesheet" href="http://localhost:1313css/hyde.css">
    
    <script defer src="https://use.fontawesome.com/releases/v5.0.9/js/all.js" integrity="sha384-8iPTk2s/jMVj81dnzb/iFR2sdA7u06vHJyyLlAd4snFpCl/SnyUjRrbdJsw1pGIl" crossorigin="anonymous"></script>
    <!-- highlight.js--> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
    <!-- Customised CSS -->
    <link rel="stylesheet" href="http://localhost:1313css/custom.css">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    

	</head>
    <body class="theme-base-0b " >
        <div class="sidebar">
	<div class="container text-center sidebar-sticky">
		<div class="sidebar-about text-center">
			<a href="http://localhost:1313"><h1 class="brand">YourTech</h1></a>
			 <img src="/img/ytjohnthumbnail.png" alt="Author Image" class="img-circle headshot center"> 
			<p class="lead">
				 Just your average, ordinary, everyday, super admin. 
			</p>
		</div>
		
<div>
	<ul class="sidebar-nav">
		
		
				<li>
					<a href="/posts/"> <span>Posts</span></a>
				</li>
				<li>
					<a href="/about/"> <span>About</span></a>
				</li>
		</li>
	</ul>
</div>

        <p>
		<section class="row text-center">
	
	<a href="https://twitter.com/ytjohn"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	&nbsp;<a href="https://github.com/ytjohn"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	&nbsp;<a href="https://stackoverflow.com/users/ytjohn"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	&nbsp;<a href="mailto:john@yourtech.us"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
</section>

        </p>

		<p class="copyright">&copy; 2018 John Hogenmiller.
        <a href="https://creativecommons.org/licenses/by/4.0">Some Rights Reserved</a>.<br/>Built with <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
        </p>
	</div>
	<div>
	</div>
</div>

        <div class="content container">
            <div class="post">
  <h1>Worst Practice Lab VM Automation</h1>
  
  <div class="col-sm-12 col-md-12">
    <span class="text-left post-date meta">
            
       
        <i class="fas fa-calendar-alt"></i> 2016-09-05
      
      
      
      
      </span>  
  </div>    
  
  

<h1 id="worst-practice-lab-vm-automation">Worst Practice Lab VM Automation</h1>

<p>I&rsquo;ve started the process of switching my lab over from unmanaged to ansible. I&rsquo;ve used Puppet and Salt quite extensively through work, but after a handful of false starts with the lab, I think ansible is the way to go.g his is a series of what
many (including myself) would consider &ldquo;worst practices&rdquo;, but are more along the lines of &ldquo;rapid iteration&rdquo;. The goal here
is to get something working in a short period of time, without spending hours, days, or weeks researching best practices.
This is instead something someone can put together on a Sunday afternoon, in between chasing after a 3 year old.</p>

<p>These are a handful of manual steps, each of which could be easily automated once you determine your &ldquo;starting point&rdquo;.</p>

<p><em>Background:</em> When I clone a VM in proxmox, it comes up with the hostname &ldquo;xenial-template&rdquo;. I should be able to do something like I do with cloud-init under kvm, but I haven&rsquo;t gotten that far under the proxmox setup. Additionally, these hosts are not in dns until they are entered into the freeipa server. Joining a client to IPA will automatically create the entry. So the first thing I need to do to any VM is to set the hostname, fqdn, and then register it with IPA. My template
has a user called &ldquo;yourtech&rdquo;, which I can use to login and configure the VM.</p>

<p>First, create an ansible vault password file: <code>echo secret&amp;gt; ~/.vault_pass.txt</code>. Next, create an and inventory directory and setup an encrypted <code>group_vars/all</code>.</p>

<pre><code>mkdir -p inventory/group_vars
touch inventory/group_vars/all
</code></pre>

<p>Add some common variables to <code>all</code>:</p>

<pre><code>---
ansible_ssh_user: yourtech
ansible_ssh_pass: secret
ansible_sudo_pass: secret
freeipaclient_server: dc01.lab.ytnoc.net
freeipaclient_domain: lab.ytnoc.net
freeipaclient_enroll_user: admin
freeipaclient_enroll_pass: supersecret
</code></pre>

<p>Then encrypt it: <code>ansible-vault --vault-password-file=~/.vault_pass.txt encrypt inventory/group_vars/all</code></p>

<h2 id="generate-inventory-files">Generate inventory files.</h2>

<p>With the following script, I can run <code>./add-new.sh example 192.168.0.121</code>. If ansible failes, then I need to
troubleshoot. A better approach would be to add these entries into a singular inventory file, or better yet,
a database, providing a constantly updated and dynamic inventory. Put that on the later pile.</p>

<pre><code>#!/usr/bin/env bash

NEWNAME=$1
IP=$2
DOMAIN=lab.ytnoc.net
FQDN=&quot;${NEWNAME}.${DOMAIN}&quot;
ANSIBLE_VAULT_PASSFILE=~/.vault_pass.txt
BASEDIR=~/projects/ytlab/inventory
FILENAME=&quot;${BASEDIR}/${NEWNAME}&quot;
LINE=&quot;${FQDN} ansible_host=${IP}&quot;

export ANSIBLE_HOST_KEY_CHECKING=False

echo ${LINE} &amp;gt; ${FILENAME}

echo &quot;Removing any prior host keys&quot;
ssh-keygen -R ${NEWNAME}
ssh-keygen -R ${FQDN}
ssh-keygen -R ${IP}

echo &quot;${FILENAME} created, testing&quot;
ansible --vault-password-file ${ANSIBLE_VAULT_PASSFILE} -i ${FILENAME} ${FQDN} -m ping -vvvv
</code></pre>

<h1 id="let-s-go-to-work">Let&rsquo;s go to work.</h1>

<p>At this point, I should have a working inventory file for a single host and I&rsquo;ve validated that ansible can
connect. Granted, I haven&rsquo;t tested <code>sudo</code>, but in my situation, I&rsquo;m pretty sure that will work. But I haven&rsquo;t
actually done anything with the VM. It&rsquo;s still just this default template.</p>

<h2 id="fqdn">FQDN</h2>

<p>Ansible provides a module to set the hostname, but does not modify <code>/etc/hosts</code> to get the FQDN resolving. As with
many things, I&rsquo;m not the first to encounter this, so I found a premade role <a href="https://github.com/holms/ansible-fqdn.git">holms/ansible-fqdn</a>.</p>

<pre><code>mkdir roles
cd roles
git clone https://github.com/holms/ansible-fqdn.git fqdn
</code></pre>

<p>This role will read <code>inventory_hostname</code> for fqdn, and <code>inventory_hostname_short</code> for hostname. You can override
this, but these are perfect defaults based on my script above.</p>

<h2 id="freeipa">FreeIPA</h2>

<p>Once again, we&rsquo;re saved by the Internet. <a href="https://github.com/alvaroaleman/ansible-freeipa-client.git">alvaroaleman/ansible-freeipa-client</a> is an already designed role that installs the necessary freeipa packages and runs the
ipa-join commands.</p>

<pre><code># assuming still in roles
git clone https://github.com/alvaroaleman/ansible-freeipa-client.git freeipa
</code></pre>

<p>The values this module needs just happens to perfectly match the freeipa_* variables I put in my <code>all</code> file earlier. I
think that&rsquo;s just amazing luck.</p>

<h2 id="make-a-playbook">Make a playbook.</h2>

<p>I call mine <code>bootstrap.yml</code>.</p>

<pre><code>---
- hosts: all
become: yes
roles:
- fqdn
- freeipa
</code></pre>

<h2 id="execute">Execute</h2>

<p>Let&rsquo;s run our playbook against host &ldquo;pgdb02&rdquo;</p>

<p><code>ansible-playbook -i inventory/pgdb02 --vault-password-file=~/.vault_pass.txt bootstrap.yml</code></p>

<p><em>Output:</em></p>

<pre><code>ytjohn@corp5510l:~/projects/ytlab$ ansible-playbook -i inventory/pgdb02 --vault-password-file=~/.vault_pass.txt base.yml

PLAY ***************************************************************************

TASK [setup] *******************************************************************
ok: [pgdb02.lab.ytnoc.net]

TASK [fqdn : fqdn | Configure Debian] ******************************************

TASK [fqdn : fqdn | Configure Redhat] ******************************************
skipping: [pgdb02.lab.ytnoc.net]

TASK [fqdn : fqdn | Configure Linux] *******************************************
included: /home/ytjohn/projects/ytlab/roles/fqdn/tasks/linux.yml for pgdb02.lab.ytnoc.net

TASK [fqdn : Set Hostname with hostname command] *******************************
changed: [pgdb02.lab.ytnoc.net]

TASK [fqdn : Re-gather facts] **************************************************
ok: [pgdb02.lab.ytnoc.net]

TASK [fqdn : Build hosts file (backups will be made)] **************************
changed: [pgdb02.lab.ytnoc.net]

TASK [fqdn : restart hostname] *************************************************
ok: [pgdb02.lab.ytnoc.net]

TASK [fqdn : fqdn | Configure Windows] *****************************************
skipping: [pgdb02.lab.ytnoc.net]

TASK [freeipa : Assert supported distribution] *********************************
ok: [pgdb02.lab.ytnoc.net]

TASK [freeipa : Assert required variables] *************************************
ok: [pgdb02.lab.ytnoc.net]

TASK [freeipa : Import variables] **********************************************
ok: [pgdb02.lab.ytnoc.net]

TASK [freeipa : Set DNS server] ************************************************
skipping: [pgdb02.lab.ytnoc.net]

TASK [freeipa : Update apt cache] **********************************************
ok: [pgdb02.lab.ytnoc.net]

TASK [freeipa : Install required packages] *************************************
changed: [pgdb02.lab.ytnoc.net] =&amp;gt; (item=[u'freeipa-client', u'dnsutils'])

TASK [freeipa : Check if host is enrolled] *************************************
ok: [pgdb02.lab.ytnoc.net]

TASK [freeipa : Enroll host in domain] *****************************************
changed: [pgdb02.lab.ytnoc.net]

TASK [freeipa : Include Ubuntu specific tasks] *********************************
included: /home/ytjohn/projects/ytlab/roles/freeipa/tasks/ubuntu.yml for pgdb02.lab.ytnoc.net

TASK [freeipa : Enable mkhomedir] **********************************************
changed: [pgdb02.lab.ytnoc.net]

TASK [freeipa : Enable sssd sudo functionality] ********************************
changed: [pgdb02.lab.ytnoc.net]

RUNNING HANDLER [freeipa : restart sssd] ***************************************
changed: [pgdb02.lab.ytnoc.net]

RUNNING HANDLER [freeipa : restart ssh] ****************************************
changed: [pgdb02.lab.ytnoc.net]

PLAY RECAP *********************************************************************
pgdb02.lab.ytnoc.net : ok=18 changed=8 unreachable=0 failed=0
</code></pre>

<h1 id="recap">Recap</h1>

<p>Essentially, we created a rather basic inventory generator script, we encrypted some
credentials into a variables file using ansible-vault, and we downloaded some roles
&quot;off the shelf&quot; and executed them both with a single &quot;bootstrap&quot; playbook.</p>

<p>If I was doing this for work, I would first create at least one Vagrant VM and work through
an entire development cycle. I would probably rewrite these roles I downloaded to make them
more flexible and variable driven.</p>

<p>In case you got lost where these files go:</p>

<pre><code>.
├── add-new.sh
├── bootstrap.yml
├── inventory
│   ├── group_vars
│   │   ├── all
│   ├── pgdb01
│   ├── pgdb02
│   └── sstorm01
└── roles
├── fqdn
└── freeipa
</code></pre>

</div>
            <div class="footer">
                <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

<script type="text/javascript">
    hljs.initHighlightingOnLoad();
</script>



            </div>
        </div>
        
                
    </body>
</html>
