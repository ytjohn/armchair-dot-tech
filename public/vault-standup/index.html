<!DOCTYPE html>
<html lang="en-us" class="wf-firasans-n4-active wf-active">
	<head>
    <link href="http://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Enable responsiveness on mobile devices --> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    
    	
    <meta name="generator" content="Hugo 0.37.1" />
    
    <title>Vault Standup &middot; YourTech</title>
    <meta content="Vault Standup - YourTech" property="og:title">
    <meta content=" - " property="og:description">    
    <!-- CSS --> 
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i|Roboto+Mono:300,300i,400,400i,700,700i" rel="stylesheet">
    <link rel="stylesheet" href="http://localhost:1313css/print.css" media="print">
    <link rel="stylesheet" href="http://localhost:1313css/poole.css">
    <link rel="stylesheet" href="http://localhost:1313css/hyde.css">
    
    <script defer src="https://use.fontawesome.com/releases/v5.0.9/js/all.js" integrity="sha384-8iPTk2s/jMVj81dnzb/iFR2sdA7u06vHJyyLlAd4snFpCl/SnyUjRrbdJsw1pGIl" crossorigin="anonymous"></script>
    <!-- highlight.js--> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
    <!-- Customised CSS -->
    <link rel="stylesheet" href="http://localhost:1313css/custom.css">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    

	</head>
    <body class="theme-base-0b " >
        <div class="sidebar">
	<div class="container text-center sidebar-sticky">
		<div class="sidebar-about text-center">
			<a href="http://localhost:1313"><h1 class="brand">YourTech</h1></a>
			 <img src="/img/ytjohnthumbnail.png" alt="Author Image" class="img-circle headshot center"> 
			<p class="lead">
				 Just your average, ordinary, everyday, super admin. 
			</p>
		</div>
		
<div>
	<ul class="sidebar-nav">
		
		
				<li>
					<a href="/posts/"> <span>Posts</span></a>
				</li>
				<li>
					<a href="/about/"> <span>About</span></a>
				</li>
		</li>
	</ul>
</div>

        <p>
		<section class="row text-center">
	
	<a href="https://twitter.com/ytjohn"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	&nbsp;<a href="https://github.com/ytjohn"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	&nbsp;<a href="https://stackoverflow.com/users/ytjohn"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	&nbsp;<a href="mailto:john@yourtech.us"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
</section>

        </p>

		<p class="copyright">&copy; 2018 John Hogenmiller.
        <a href="https://creativecommons.org/licenses/by/4.0">Some Rights Reserved</a>.<br/>Built with <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
        </p>
	</div>
	<div>
	</div>
</div>

        <div class="content container">
            <div class="post">
  <h1>Vault Standup</h1>
  
  <div class="col-sm-12 col-md-12">
    <span class="text-left post-date meta">
            
       
        <i class="fas fa-calendar-alt"></i> 2017-10-14
      
      
      
      
      </span>  
  </div>    
  
  <p>This is a little walkthrough of settng up a &ldquo;production-like&rdquo; vault server with etcd backend (Not really production, no TLS and one person with all the keys). <a href="https://www.vaultproject.io/">Hashicorp Vault</a> is incredibly easy to setup. Going through the dev walkthrough is pretty easy, but when you want to get a little more advanced, you start getting bounced around the documentation. So these are my notes of setting up a vault server with an etcd backend and a few policies/tokens for access. Consider this part 1, and in &ldquo;part 2&rdquo;, I&rsquo;ll setup an ldap backend.</p>

<p>Q: Why etcd instead of consul?<br />
A: Most of the places I know that run consul, run it across multiple datacenters, and a few thousand servers, and interacts with lots of different services. Even if the secrets are protected, the metadata is quite visible. I want a rather compact and isolated backend for my eventual cluster.</p>

<p>Let&rsquo;s get started.</p>

<p>First off, create a configuration file for vault.</p>

<p>vaultserver.hcl:</p>

<pre><code>metaladmin@vaultcore01:~$ cat vaultserver.hcl
storage &quot;etcd&quot; {
  address  = &quot;http://localhost:2379&quot;
  etcd_api = &quot;v2&quot;
  path = &quot;corevault&quot;
}

listener &quot;tcp&quot; {
  address = &quot;0.0.0.0:8200&quot;
  tls_disable = 1
}

disable_mlock = true
cluster_name = &quot;corevault&quot;
</code></pre>

<p>Start the server (in its own terminal)</p>

<pre><code>metaladmin@vaultcore01:~$ vault server -config=vaultserver.hcl
==&gt; Vault server configuration:

                     Cgo: disabled
              Listener 1: tcp (addr: &quot;0.0.0.0:8200&quot;, cluster address: &quot;0.0.0.0:8201&quot;, tls: &quot;disabled&quot;)
</code></pre>

<p>Init the server</p>

<pre><code>dfzmbp:~ ytjohn$ export VAULT_ADDR=http://vaultcore01.pool.lab.ytnoc.net:8200
dfzmbp:~ ytjohn$ vault init
Unseal Key 1: f9XJwuxla/H86t8pbWVPnI6Tfi3nQtkasq303Oi8B+ep
Unseal Key 2: jFqEmE1c/lei+C1aIju6JM2t5fSI534g26E7Nv83t9RV
Unseal Key 3: ty/P+Jubm1BukPcdZ16eJFD0JQ9BFGqOSgft35/fvHXr
Unseal Key 4: 6k4aPjuKgz0UNe+hTVAOKUzrIvbS9w8UszB0HX3Au496
Unseal Key 5: PYNjRe9vBvHAGE9peiotrtjoYuVlAV/9QJ0NvqZScd2a
Initial Root Token: b6eac78d-f278-4d32-6894-a8168d055340
</code></pre>

<p>That Initial Root Token is your only means of accessing the vault once it&#039;s unsealed. Don&#039;t lose it until you replace it.</p>

<p>And this creates a directory in etcd (or consul)</p>

<pre><code>metaladmin@vaultcore01:~$ etcdctl ls
/test1
/corevault
metaladmin@vaultcore01:~$ etcdctl ls /corevault
/corevault/sys
/corevault/core
</code></pre>

<p>Unseal it:</p>

<pre><code>dfzmbp:~ ytjohn$ vault unseal
Key (will be hidden):
Sealed: true
Key Shares: 5
Key Threshold: 3
Unseal Progress: 1
Unseal Nonce: d860cb16-f084-925d-6f41-d80ef15e297c
dfzmbp:~ ytjohn$ vault unseal
Key (will be hidden):
Sealed: true
Key Shares: 5
Key Threshold: 3
Unseal Progress: 2
Unseal Nonce: d860cb16-f084-925d-6f41-d80ef15e297c
dfzmbp:~ ytjohn$ vault unseal
Key (will be hidden):
Sealed: false
Key Shares: 5
Key Threshold: 3
Unseal Progress: 0
Unseal Nonce:
dfzmbp:~ ytjohn$ vault unseal
Vault is already unsealed.
</code></pre>

<p>Now let&#039;s take that root token and save it in our home directory. Not safe, because it&#039;s the all-powerful root token, you shold create a user token for yourself. But that&#039;s later.</p>

<p>Save your token (or export it as VAULT_TOKEN), then write and read some secrets.</p>

<pre><code>echo b6eac78d-f278-4d32-6894-a8168d055340 &gt; ~/.vault-token
dfzmbp:~ ytjohn$ vault read secret/hello
Key             	Value
---             	-----
refresh_interval	768h0m0s
value           	world

dfzmbp:~ ytjohn$ vault read -format=json secret/hello
{
	&quot;request_id&quot;: &quot;a4b199e7-ff7c-e249-2944-17424bf1f05c&quot;,
	&quot;lease_id&quot;: &quot;&quot;,
	&quot;lease_duration&quot;: 2764800,
	&quot;renewable&quot;: false,
	&quot;data&quot;: {
		&quot;value&quot;: &quot;world&quot;
	},
	&quot;warnings&quot;: null
}

dfzmbp:~ ytjohn$ helloworld=`vault read -field=value secret/hello`
dfzmbp:~ ytjohn$ echo $helloworld
world
</code></pre>

<p>Ok, that&rsquo;s the basics of getting vault up and running. Now we want to get more users to access it. What I want is to create three &ldquo;users&rdquo; and give them each a path.</p>

<p>infra admins = able to create, read, and write to <code>secret/infra/*</code>
infra compute = work within the <code>secret/infra/compute</code> area.
infra network = work within the <code>secret/infra/network</code> area</p>

<p>infraadmin.hcl</p>

<pre><code>path &amp;quot;secret/infra/*&amp;quot; {
  capabilities = [&amp;quot;create&amp;quot;]
}

path &amp;quot;auth/token/lookup-self&amp;quot; {
  capabilities = [&amp;quot;read&amp;quot;]
}
</code></pre>

<p>infracompute.hcl</p>

<pre><code>path &amp;quot;secret/infra/compute/*&amp;quot; {
  capabilities = [&amp;quot;create&amp;quot;]
}

path &amp;quot;auth/token/lookup-self&amp;quot; {
  capabilities = [&amp;quot;read&amp;quot;]
}
</code></pre>

<p>infranetwork.hcl</p>

<pre><code>path &amp;quot;secret/infra/network/*&amp;quot; {
  capabilities = [&amp;quot;create&amp;quot;]
}

path &amp;quot;secret/infra/compute/obm/*&amp;quot; {
  capabilities = [&amp;quot;read&amp;quot;]
}

path &amp;quot;auth/token/lookup-self&amp;quot; {
  capabilities = [&amp;quot;read&amp;quot;]
}
</code></pre>

<p>Now, we write these policies in.</p>

<pre><code>dfzmbp:vault ytjohn$ vault policy-write infraadmin infraadmin.hcl
Policy &amp;#039;infraadmin&amp;#039; written.
dfzmbp:vault ytjohn$ vault policy-write infracompute infracompute.hcl
Policy &amp;#039;infracompute&amp;#039; written.
dfzmbp:vault ytjohn$ vault policy-write infranetwork infranetwork.hcl
Policy &amp;#039;infranetwork&amp;#039; written.
</code></pre>

<p>Let&rsquo;s create a token &ldquo;user&rdquo; for each policy.</p>

<pre><code>dfzmbp:vault ytjohn$ vault token-create -policy=&amp;quot;infraadmin&amp;quot;
Key            	Value
---            	-----
token          	d16dd3dc-cd9e-15e1-8e41-fef4168a429e
token_accessor 	50a1162f-58a2-474c-466d-ec68fac9a2f9
token_duration 	768h0m0s
token_renewable	true
token_policies 	[default infraadmin]

dfzmbp:vault ytjohn$ vault token-create -policy=&amp;quot;infracompute&amp;quot;
Key            	Value
---            	-----
token          	d156326d-1ee6-7a93-d9d3-428e2211962d
token_accessor 	daf3beb4-6c31-4115-2d00-ba811c50b05b
token_duration 	768h0m0s
token_renewable	true
token_policies 	[default infracompute]

dfzmbp:vault ytjohn$ vault token-create -policy=&amp;quot;infranetwork&amp;quot;
Key            	Value
---            	-----
token          	84faa448-20d9-b472-349f-1053c81ff4c9
token_accessor 	68eea7ec-78c0-4be1-03c4-f2ec155b66de
token_duration 	768h0m0s
token_renewable	true
token_policies 	[default infranetwork]
</code></pre>

<p>Let&rsquo;s login as with the infranetwork token and attempt to write to compute. I have not yet created <code>secret/infra/compute</code> or <code>secret/infra/network</code> and I&rsquo;m curious if infraadmin is needed to make those first.</p>

<pre><code>dfzmbp:vault ytjohn$ vault auth 84faa448-20d9-b472-349f-1053c81ff4c9
Successfully authenticated! You are now logged in.
token: 84faa448-20d9-b472-349f-1053c81ff4c9
token_duration: 2764764
token_policies: [default infranetwork]
dfzmbp:vault ytjohn$ vault write secret/infra/compute/notallowed try=wemust
Error writing data to secret/infra/compute/notallowed: Error making API request.

URL: PUT http://vaultcore01.pool.lab.ytnoc.net:8200/v1/secret/infra/compute/notallowed
Code: 403. Errors:

* permission denied
dfzmbp:vault ytjohn$ vault write secret/infra/network/allowed alreadyexists=maybe
Success! Data written to: secret/infra/network/allowed
</code></pre>

<p>I got blocked from creating a path inside of compute, and I didn&rsquo;t need <code>secret/infra/network</code> created before making a child path. That infraadmin account is really not needed at all. Let&rsquo;s go ahead and try infracompute.</p>

<pre><code>$ vault auth d156326d-1ee6-7a93-d9d3-428e2211962d # auth as infracompute
$ vault write secret/infra/compute/obm/idrac/oem username=root password=calvin
Success! Data written to: secret/infra/compute/obm/idrac/oem
$ vault read secret/infra/compute/obm/idrac/oem
Error reading secret/infra/compute/obm/idrac/oem: Error making API request.

URL: GET http://vaultcore01.pool.lab.ytnoc.net:8200/v1/secret/infra/compute/obm/idrac/oem
Code: 403. Errors:

* permission denied
</code></pre>

<p>Oh my. I gave myself create, but not read permissions.  New policies.</p>

<p>infranetwork.hcl</p>

<pre><code>path &amp;quot;secret/infra/network/*&amp;quot; {
  capabilities = [&amp;quot;create&amp;quot;, &amp;quot;read&amp;quot;, &amp;quot;update&amp;quot;, &amp;quot;delete&amp;quot;, &amp;quot;list&amp;quot;]
}

path &amp;quot;secret/infra/compute/obm/*&amp;quot; {
  capabilities = [&amp;quot;read&amp;quot;, &amp;quot;list&amp;quot;]
}

path &amp;quot;auth/token/lookup-self&amp;quot; {
  capabilities = [&amp;quot;read&amp;quot;]
}
</code></pre>

<p>infracompute.hcl</p>

<pre><code>path &amp;quot;secret/infra/compute/*&amp;quot; {
  capabilities = [&amp;quot;create&amp;quot;, &amp;quot;read&amp;quot;, &amp;quot;update&amp;quot;, &amp;quot;delete&amp;quot;, &amp;quot;list&amp;quot;]
}

path &amp;quot;auth/token/lookup-self&amp;quot; {
  capabilities = [&amp;quot;read&amp;quot;]
}
</code></pre>

<p>Let&rsquo;s update our policy list and cleanup.</p>

<pre><code>vault auth b6eac78d-f278-4d32-6894-a8168d055340 # auth as root token
vault policy-delete infraadmin # delete unneeded infradmin policy
vault token-revoke d16dd3dc-cd9e-15e1-8e41-fef4168a429e # remove infraadmin token
vault policy-write infranetwork infranetwork.hcl
vault policy-write infracompute infracompute.hcl
</code></pre>

<p>Try again:</p>

<pre><code>$ vault auth d156326d-1ee6-7a93-d9d3-428e2211962d # auth as infracompute
Successfully authenticated! You are now logged in.
token: d156326d-1ee6-7a93-d9d3-428e2211962d
token_duration: 2762315
token_policies: [default infracompute]
$ vault read secret/infra/compute/obm/idrac/oem
Key             	Value
---             	-----
refresh_interval	768h0m0s
password        	calvin
username        	root
</code></pre>

<p>And as network</p>

<pre><code>$ vault auth 84faa448-20d9-b472-349f-1053c81ff4c9 #infranetwork
$ vault list secret/infra/compute
Error reading secret/infra/compute/: Error making API request.

URL: GET http://vaultcore01.pool.lab.ytnoc.net:8200/v1/secret/infra/compute?list=true
Code: 403. Errors:

* permission denied
$ vault list secret/infra/compute/obm
Keys
----
idrac/

$ vault list secret/infra/compute/obm/idrac
Keys
----
oem

$ vault read secret/infra/compute/obm/idrac/oem
Key             	Value
---             	-----
refresh_interval	768h0m0s
password        	calvin
username        	root
</code></pre>

</div>
            <div class="footer">
                <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

<script type="text/javascript">
    hljs.initHighlightingOnLoad();
</script>



            </div>
        </div>
        
                
    </body>
</html>
